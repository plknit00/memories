<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Add Memory (Works if memories.txt empty or missing)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 500px;
    margin: auto;
    padding: 20px;
  }
  input, textarea {
    width: 100%;
    margin: 8px 0;
    padding: 8px;
    box-sizing: border-box;
  }
  button {
    padding: 10px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }
  pre {
    background: #f4f4f4;
    padding: 10px;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 250px;
    overflow-y: auto;
  }
  label {
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>Add a New Memory</h2>

<label>Password:</label>
<input type="password" id="password" placeholder="Enter your password">

<label>Memory Text:</label>
<textarea id="memoryText" placeholder="Enter your memory"></textarea>

<label>Image URL (optional):</label>
<input type="url" id="memoryImage" placeholder="https://example.com/photo.jpg">

<button onclick="addMemory()">Add Memory & Re-encrypt</button>

<h3>Updated Encrypted Data:</h3>
<pre id="output"></pre>

<!-- CryptoJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
async function addMemory() {
  const password = document.getElementById('password').value;
  const text = document.getElementById('memoryText').value.trim();
  const image = document.getElementById('memoryImage').value.trim();
  const output = document.getElementById('output');

  if (!password || !text) {
    alert("Password and memory text are required.");
    return;
  }

  try {
    const res = await fetch('memories.txt');
    let memories = [];

    if (res.ok) {
      const encryptedData = await res.text();
      console.log("Encrypted data fetched:", JSON.stringify(encryptedData));

      if (encryptedData.trim().length > 0) {
        // Try decrypting
        const bytes = CryptoJS.AES.decrypt(encryptedData, password);
        const decryptedStr = bytes.toString(CryptoJS.enc.Utf8);
        console.log("Decrypted string:", decryptedStr);

        if (!decryptedStr) {
          alert("Password incorrect or file corrupted.");
          return;
        }
        try {
          memories = JSON.parse(decryptedStr);
        } catch (jsonErr) {
          console.error("JSON parse error:", jsonErr);
          alert("Decrypted data is not valid JSON.");
          return;
        }
      } else {
        console.log("memories.txt is empty, starting fresh.");
      }
    } else {
      console.log("memories.txt not found, starting fresh.");
    }

    // Add new memory
    const newMemory = { text };
    if (image) newMemory.image = image;
    memories.push(newMemory);

    const newEncrypted = CryptoJS.AES.encrypt(JSON.stringify(memories), password).toString();

    output.textContent = newEncrypted;
    alert("Memory added! Copy the above encrypted text into memories.txt");

  } catch (err) {
    console.error("Unexpected error:", err);
    alert("Error decrypting or processing memories.");
  }
}

</script>
</body>
</html>
